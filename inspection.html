<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Inspection Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Warm Neutrals with Green/Red Accents -->
    <!-- Application Structure Plan: A tabbed navigation SPA. Sections are: "Dashboard", "Food & Prep", "Operations", "Front of House", "Photo Gallery", "Action Plan", and "Summary". This groups items logically for a streamlined workflow, separating high-level summaries (Dashboard) from detailed checks, the final actionable output (Action Plan), and a concluding summary with signatures. This interactive structure is more efficient and clearer than a static form. -->
    <!-- Visualization & Content Choices: 
        - Overall Compliance (Dashboard): Goal: Inform at a glance. Viz/Method: Donut chart (Chart.js) showing Pass vs. Fail percentages. Interaction: Hover for details. Justification: A donut chart is excellent for showing part-to-whole relationships, providing an immediate understanding of the overall result.
        - Scoring Breakdown (Dashboard): Goal: Compare performance across areas. Viz/Method: Bar chart (Chart.js) showing scores for each category. Justification: Bar charts are ideal for direct comparison between different categories.
        - Checklist Items (Section Views): Goal: Organize and record inspection details. Viz/Method: Interactive HTML list items with "Pass", "Fail", and "N/A" buttons. Interaction: Clicking "Fail" reveals a comment input, photo upload, and severity level. Data is stored in a JS object. Justification: This provides immediate visual feedback and streamlines data entry.
        - Action Plan (Action Plan View): Goal: Organize and assign corrective actions. Viz/Method: Dynamically generated HTML table. Interaction: The table is auto-populated from all "Failed" items, including photo evidence, severity, and resolution status, and can be sorted. Justification: Automating and sorting the action plan creation saves time and ensures no failed items are missed.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
        }
        .nav-link {
            transition: all 0.3s ease;
            border-bottom: 2px solid transparent;
        }
        .nav-link.active {
            border-bottom-color: #4f46e5;
            color: #4f46e5;
            font-weight: 600;
        }
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
        }
        .pass-fail-btn {
            transition: all 0.2s ease-in-out;
        }
        .item-pending { background-color: #ffffff; }
        .item-pass { background-color: #e8f5e9; border-left: 4px solid #4caf50; }
        .item-fail { background-color: #ffebee; border-left: 4px solid #f44336; }
        .item-na { background-color: #f5f5f5; border-left: 4px solid #9e9e9e; }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
            height: 250px;
            max-height: 300px;
        }
         @media (min-width: 768px) { .chart-container { height: 300px; } }
         
         @media print {
            body {
                background-color: #ffffff;
            }
            .no-print, .pass-fail-btn-container, nav, header .print-btn-container, .interactive-header {
                display: none;
            }
            #print-header, #print-summary-comments, #print-general-notes {
                display: block !important;
            }
            .content-section {
                display: block !important; /* Show all sections when printing */
                margin-bottom: 2rem;
            }
            .bg-white, .p-4, .p-6, .p-8 {
                box-shadow: none !important;
                border: 1px solid #e2e8f0;
            }
            .item-pass {
                background-color: #e8f5e9 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .item-fail {
                background-color: #ffebee !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .item-na {
                background-color: #f5f5f5 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            h1, h2 {
                page-break-after: avoid;
            }
            .action-item, .signature-section {
                page-break-inside: avoid;
            }
            .photo-preview img {
                max-width: 150px !important;
                max-height: 150px !important;
                display: inline-block !important;
                margin-right: 8px;
                margin-bottom: 8px;
            }
         }
    </style>
</head>
<body class="text-gray-800">

    <div id="print-header" class="hidden p-8">
        <h1 class="text-3xl font-bold text-center mb-2">Restaurant Inspection Report</h1>
        <div class="text-center text-sm text-gray-600 mb-2">
            <span id="print-inspection-id" class="font-mono text-xs"></span>
        </div>
        <div class="text-center text-sm text-gray-600 mb-8 border-b pb-4 flex justify-center flex-wrap gap-x-2">
            <span id="print-store-name" class="font-semibold"></span>
            <span class="text-gray-400">|</span>
            <span id="print-location"></span>
            <span class="text-gray-400">|</span>
            <span id="print-date"></span>
            <span class="text-gray-400">|</span>
            <span id="print-inspector"></span>
        </div>
    </div>
    
    <div id="print-summary-comments" class="hidden px-8"></div>
    <div id="print-general-notes" class="hidden px-8"></div>

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        
        <div id="save-indicator" class="fixed top-5 right-5 bg-green-500 text-white text-sm font-bold px-4 py-2 rounded-lg shadow-lg transition-opacity duration-300 opacity-0 no-print">
            Saved!
        </div>

        <div id="reset-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden no-print z-50">
            <div class="bg-white p-8 rounded-lg shadow-xl text-center max-w-sm mx-4">
                <h2 class="text-xl font-bold mb-4">Confirm Reset</h2>
                <p class="text-gray-600 mb-6">Are you sure you want to reset the entire inspection? All current data will be lost.</p>
                <div class="flex justify-center gap-4">
                    <button id="cancel-reset" class="bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button id="confirm-reset" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700">Confirm</button>
                </div>
            </div>
        </div>

        <header class="mb-8 flex flex-col sm:flex-row justify-between items-start gap-4 interactive-header">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Restaurant Inspection Report</h1>
                <p class="text-gray-600 mt-2">An interactive dashboard to manage and track store inspections.</p>
            </div>
            <div class="print-btn-container flex flex-wrap gap-2">
                 <button id="export-csv-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition flex items-center gap-2">
                    <span class="text-xl">üìÑ</span> Export CSV
                </button>
                <button id="reset-btn" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition flex items-center gap-2">
                    <span class="text-xl">üîÑ</span> Reset
                </button>
                <button id="print-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition flex items-center gap-2">
                    <span class="text-xl">üñ®Ô∏è</span> Save as PDF
                </button>
            </div>
        </header>

        <div class="bg-white rounded-lg shadow-md p-4 mb-8 no-print">
             <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                <div>
                    <label for="storeName" class="font-semibold text-gray-700 block">Store Name</label>
                    <input type="text" id="storeName" value="" placeholder="e.g., Downtown Pizzeria" class="w-full p-2 border rounded mt-1 bg-gray-50 state-input">
                </div>
                 <div>
                    <label for="location" class="font-semibold text-gray-700 block">Location</label>
                    <input type="text" id="location" value="" placeholder="e.g., Vancouver, BC" class="w-full p-2 border rounded mt-1 bg-gray-50 state-input">
                </div>
                <div>
                    <label for="inspector" class="font-semibold text-gray-700 block">Inspected By</label>
                    <input type="text" id="inspector" value="" placeholder="e.g., Jane Doe" class="w-full p-2 border rounded mt-1 bg-gray-50 state-input">
                </div>
                 <div>
                    <label for="inspectionDate" class="font-semibold text-gray-700 block">Inspection Date</label>
                    <input type="date" id="inspectionDate" value="" class="w-full p-2 border rounded mt-1 bg-gray-50 state-input">
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-4 mb-8 no-print">
            <div class="w-full bg-gray-200 rounded-full h-2.5">
                <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
            </div>
            <p id="progress-text" class="text-center text-sm text-gray-600 mt-2">0% Complete</p>
        </div>

        <nav class="bg-white rounded-lg shadow-md p-2 mb-8 flex items-center justify-center flex-wrap gap-2 md:gap-8 no-print">
            <a href="#dashboard" class="nav-link p-2 text-gray-600 font-medium active">üìà Dashboard</a>
            <a href="#food" class="nav-link p-2 text-gray-600 font-medium">üçï Food & Prep</a>
            <a href="#operations" class="nav-link p-2 text-gray-600 font-medium">‚öôÔ∏è Operations</a>
            <a href="#foh" class="nav-link p-2 text-gray-600 font-medium">üçΩÔ∏è Front of House</a>
            <a href="#gallery" class="nav-link p-2 text-gray-600 font-medium">üñºÔ∏è Photo Gallery</a>
            <a href="#action-plan" class="nav-link p-2 text-gray-600 font-medium">üìã Action Plan</a>
            <a href="#summary" class="nav-link p-2 text-gray-600 font-medium">‚úçÔ∏è Summary & Signatures</a>
        </nav>
        
        <main>
            <div id="dashboard" class="content-section active">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-bold mb-4 text-center">Overall Score</h2>
                        <div class="chart-container">
                            <canvas id="inspectionChart"></canvas>
                        </div>
                        <div id="summary-text" class="mt-4 text-center text-gray-600"></div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-bold mb-4 text-center">Score by Category</h2>
                        <div class="chart-container">
                            <canvas id="categoryScoreChart"></canvas>
                        </div>
                    </div>
                    <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-bold mb-4">Business Performance</h2>
                         <p class="text-gray-600 mb-6">Enter key performance indicators for this period to correlate operational standards with financial outcomes.</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <label for="daily-sales" class="text-sm font-medium text-gray-500">Average Daily Sales</label>
                                <div class="flex items-center mt-1">
                                    <span class="text-gray-500 text-2xl mr-2">$</span>
                                    <input type="number" id="daily-sales" class="text-3xl font-bold bg-transparent w-full focus:outline-none state-input" placeholder="0.00">
                                </div>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <label for="monthly-sales" class="text-sm font-medium text-gray-500">Average Monthly Sales</label>
                                <div class="flex items-center mt-1">
                                    <span class="text-gray-500 text-2xl mr-2">$</span>
                                    <input type="number" id="monthly-sales" class="text-3xl font-bold bg-transparent w-full focus:outline-none state-input" placeholder="0.00">
                                </div>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <label for="food-cost" class="text-sm font-medium text-gray-500">Food Cost</label>
                                 <div class="flex items-center mt-1">
                                    <input type="number" id="food-cost" class="text-3xl font-bold bg-transparent w-full focus:outline-none state-input" placeholder="0.00">
                                    <span class="text-gray-500 text-2xl ml-2">%</span>
                                </div>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <label for="labor-cost" class="text-sm font-medium text-gray-500">Labor Cost</label>
                                <div class="flex items-center mt-1">
                                     <input type="number" id="labor-cost" class="text-3xl font-bold bg-transparent w-full focus:outline-none state-input" placeholder="0.00">
                                     <span class="text-gray-500 text-2xl ml-2">%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="food" class="content-section"></div>
            <div id="operations" class="content-section"></div>
            <div id="foh" class="content-section"></div>

             <div id="gallery" class="content-section">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-bold mb-4">Photo Gallery</h2>
                    <p class="text-gray-600 mb-6">This gallery contains all photo evidence uploaded for failed items, organized by category.</p>
                    <div id="photo-gallery-content" class="space-y-8">
                        <p class="text-gray-500">No photos have been uploaded yet.</p>
                    </div>
                </div>
            </div>

            <div id="action-plan" class="content-section">
                 <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                        <h2 class="text-2xl font-bold mb-2 sm:mb-0">Corrective Action Plan</h2>
                        <div class="no-print">
                            <label for="sort-action-plan" class="text-sm font-medium mr-2">Sort by:</label>
                            <select id="sort-action-plan" class="p-2 border rounded bg-gray-50">
                                <option value="default">Default</option>
                                <option value="severity">Severity (High to Low)</option>
                            </select>
                        </div>
                    </div>
                    <p class="text-gray-600 mb-6 no-print">This section automatically lists all failed items. Sort by severity to prioritize critical actions.</p>
                    <div id="action-plan-content" class="space-y-4">
                        <p class="text-gray-500">No failed items requiring action. Great job!</p>
                    </div>
                </div>
            </div>

            <div id="summary" class="content-section">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-bold mb-4">Overall Summary & Signatures</h2>
                    <p class="text-gray-600 mb-6 no-print">Provide final comments and obtain signatures to complete the inspection report.</p>
                    
                    <div class="mb-8">
                        <label for="overall-comments" class="font-semibold text-gray-700 block mb-2">Inspector's Overall Comments & Recommendations</label>
                        <textarea id="overall-comments" rows="6" class="w-full p-2 border rounded bg-gray-50 state-input" placeholder="e.g., The store is generally well-maintained, but attention is needed in staff uniform compliance and floor cleaning procedures..."></textarea>
                    </div>
    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-12 signature-section">
                        <div>
                            <label for="inspector-signature" class="font-semibold text-gray-700 block">Inspector Signature</label>
                            <input type="text" id="inspector-signature" class="w-full mt-2 p-2 border-b-2 border-gray-300 focus:outline-none focus:border-indigo-500 bg-transparent state-input">
                        </div>
                        <div>
                            <label for="manager-signature" class="font-semibold text-gray-700 block">Store Manager Signature (Acknowledgement)</label>
                            <input type="text" id="manager-signature" class="w-full mt-2 p-2 border-b-2 border-gray-300 focus:outline-none focus:border-indigo-500 bg-transparent state-input">
                        </div>
                    </div>
                </div>
            </div>
        </main>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const initialState = [
                { id: 1, category: 'food', text: 'Products are ordered from recognized, approved suppliers.', status: 'pending', comment: '', photos: [], severity: 'low' },
                { id: 2, category: 'food', text: 'Dough is made/processed according to the production book.', status: 'pending', comment: '', photos: [], severity: 'low' },
                { id: 3, category: 'food', text: 'Tomato sauce is made according to the production book.', status: 'pending', comment: '', photos: [], severity: 'low' },
                { id: 4, category: 'food', text: 'Alfredo, pesto, and other sauces are thawed and used correctly.', status: 'pending', comment: '', photos: [], severity: 'low' },
                { id: 5, category: 'food', text: 'Meats/chicken are marinated and cooked properly.', status: 'pending', comment: '', photos: [], severity: 'low' },
                { id: 6, category: 'food', text: 'Vegetables are roasted according to procedure.', status: 'pending', comment: '', photos: [], severity: 'low' },
                { id: 7, category: 'food', text: 'Fresh vegetables are cut to the correct size and standard.', status: 'pending', comment: '', photos: [], severity: 'low' },
                { id: 8, category: 'food', text: 'Marinated items (spinach, artichoke, etc.) are prepared correctly.', status: 'pending', comment: '', photos: [], severity: 'low' },
                { id: 9, category: 'food', text: 'Sufficient toppings are prepared for the daily rush.', status: 'pending', comment: '', photos: [], severity: 'low' },
                { id: 10, category: 'food', text: 'All prepared toppings are fresh and handled properly.', status: 'pending', comment: '', photos: [], severity: 'low' },
                { id: 11, category: 'operations', text: 'Display glass/shelf is clean and free of debris.', status: 'pending', comment: '', photos: [], severity: 'low' },
                { id: 12, category: 'operations', text: 'Display is stocked with a variety of fresh pizzas.', status: 'pending', comment: '', photos: [], severity: 'low' },
                { id: 13, category: 'operations', text: 'Pizza selection on display reflects the menu.', status: 'pending', comment: '', photos: [], severity: 'low' },
                { id: 14, category: 'operations', text: 'No old or unappealing pizzas/slices on display.', status: 'pending', comment: '', photos: [], severity: 'low' },
                { id: 15, category: 'operations', text: 'All cheeses are in stock and available.', status: 'pending', comment: '', photos: [], severity: 'low' },
                { id: 16, category: 'operations', text: 'All meats are ordered and sliced properly.', status: 'pending', comment: '', photos: [], severity: 'low' },
                { id: 17, category: 'operations', text: 'All items on the menu are available for order.', status: 'pending', comment: '', photos: [], severity: 'low' },
                { id: 18, category: 'operations', text: 'All inventory is available and rotated (FIFO).', status: 'pending', comment: '', photos: [], severity: 'low' },
                { id: 19, category: 'operations', text: 'Dough racks are properly dated.', status: 'pending', comment: '', photos: [], severity: 'low' },
                { id: 20, category: 'operations', text: 'All equipment is checked and cleaned regularly.', status: 'pending', comment: '', photos: [], severity: 'low' },
                { id: 21, category: 'operations', text: 'All equipment is in good working order.', status: 'pending', comment: '', photos: [], severity: 'low' },
                { id: 22, category: 'operations', text: 'Refrigerators and ovens are at the correct temperature.', status: 'pending', comment: '', photos: [], severity: 'low' },
                { id: 23, category: 'foh', text: 'Employees are providing good customer service.', status: 'pending', comment: '', photos: [], severity: 'low' },
                { id: 24, category: 'foh', text: 'All employees are in a clean, correct uniform.', status: 'pending', comment: '', photos: [], severity: 'low' },
                { id: 25, category: 'foh', text: 'Entrance and exit are clear of obstructions.', status: 'pending', comment: '', photos: [], severity: 'low' },
                { id: 26, category: 'foh', text: 'Cash registers and monitors are clean and organized.', status: 'pending', comment: '', photos: [], severity: 'low' },
                { id: 27, category: 'foh', text: 'Tables and chairs are clean and in good condition.', status: 'pending', comment: '', photos: [], severity: 'low' },
                { id: 28, category: 'foh', text: 'Store glass, doors, walls, and floors are clean.', status: 'pending', comment: '', photos: [], severity: 'low' },
                { id: 29, category: 'foh', text: 'Restrooms are clean and well-stocked.', status: 'pending', comment: '', photos: [], severity: 'low' },
                { id: 30, category: 'foh', text: 'Store signs and menus are updated and in good condition.', status: 'pending', comment: '', photos: [], severity: 'low' },
                { id: 31, category: 'foh', text: 'Store is using the latest/newest menu version.', status: 'pending', comment: '', photos: [], severity: 'low' },
                { id: 32, category: 'foh', text: 'Flyers are being distributed regularly (if applicable).', status: 'pending', comment: '', photos: [], severity: 'low' },
            ];
            
            let inspectionData = [];
            let nextItemId = 0;
            let inspectionId = '';
            const navLinks = document.querySelectorAll('.nav-link');
            const contentSections = document.querySelectorAll('.content-section');
            let inspectionChart, categoryScoreChart;

            const sectionTitles = {
                food: 'Food & Prep',
                operations: 'Operations',
                foh: 'Front of House'
            };

            const severityColors = {
                low: 'bg-yellow-200 text-yellow-800',
                medium: 'bg-orange-200 text-orange-800',
                high: 'bg-red-200 text-red-800',
            };
            
            function buildChecklistItem(item) {
                const printCommentHtml = item.comment ? `<p class="text-sm text-gray-700 mt-1"><strong>Comment:</strong> ${item.comment}</p>` : '';
                return `
                    <div id="item-${item.id}" class="p-4 rounded-lg shadow-sm item-${item.status}">
                        <div class="flex justify-between items-center">
                            <p class="text-gray-800 flex-1">${item.text}</p>
                            <div class="flex space-x-2 ml-4 pass-fail-btn-container">
                                <button data-id="${item.id}" data-status="pass" class="pass-fail-btn px-3 py-1 text-sm font-medium rounded-full ${item.status === 'pass' ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-700'}">Pass</button>
                                <button data-id="${item.id}" data-status="fail" class="pass-fail-btn px-3 py-1 text-sm font-medium rounded-full ${item.status === 'fail' ? 'bg-red-500 text-white' : 'bg-gray-200 text-gray-700'}">Fail</button>
                                <button data-id="${item.id}" data-status="na" class="pass-fail-btn px-3 py-1 text-sm font-medium rounded-full ${item.status === 'na' ? 'bg-gray-500 text-white' : 'bg-gray-200 text-gray-700'}">N/A</button>
                            </div>
                        </div>
                        <div class="hidden print:block mt-2">${printCommentHtml}</div>
                        <div id="details-container-${item.id}" class="mt-3 pt-3 border-t border-gray-200 ${item.status === 'fail' ? '' : 'hidden'}">
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label class="text-xs font-semibold text-gray-600 block mb-1">Comment</label>
                                    <input type="text" data-id="${item.id}" class="comment-input w-full p-2 border rounded bg-white no-print" placeholder="Add comment for failure..." value="${item.comment || ''}">
                                </div>
                                <div>
                                    <label class="text-xs font-semibold text-gray-600 block mb-1">Severity</label>
                                    <select data-id="${item.id}" class="severity-select w-full p-2 border rounded bg-white no-print">
                                        <option value="low" ${item.severity === 'low' ? 'selected' : ''}>Low</option>
                                        <option value="medium" ${item.severity === 'medium' ? 'selected' : ''}>Medium</option>
                                        <option value="high" ${item.severity === 'high' ? 'selected' : ''}>High</option>
                                    </select>
                                </div>
                            </div>
                             <div class="mt-4">
                                <label class="text-xs font-semibold text-gray-600 block mb-1">Photo Evidence</label>
                                <input type="file" data-id="${item.id}" class="photo-input text-sm no-print" accept="image/*" multiple>
                                <div class="photo-preview mt-2 flex flex-wrap gap-2">
                                    ${item.photos.map(p => `<img src="${p}" class="w-24 h-24 object-cover rounded-md shadow-sm"/>`).join('')}
                                </div>
                             </div>
                        </div>
                    </div>
                `;
            }

            function renderChecklists() {
                const groupedData = inspectionData.reduce((acc, item) => {
                    (acc[item.category] = acc[item.category] || []).push(item);
                    return acc;
                }, {});

                for (const category in groupedData) {
                    const container = document.getElementById(category);
                    if (container) {
                        const itemsHtml = groupedData[category].map(buildChecklistItem).join('');
                        container.innerHTML = `
                            <div class="bg-white p-6 rounded-lg shadow-md">
                                <h2 class="text-2xl font-bold mb-2">${sectionTitles[category]}</h2>
                                <p class="text-gray-600 mb-6 no-print">Evaluate each item in this section. Mark as 'Pass', 'Fail', or 'N/A'. For failed items, a comment box will appear to note necessary actions.</p>
                                <div class="space-y-3" id="checklist-container-${category}">
                                    ${itemsHtml}
                                </div>
                                <div class="mt-6 pt-4 border-t border-gray-200 no-print">
                                    <label for="notes-${category}" class="font-semibold text-gray-700 block mb-2">General Notes for ${sectionTitles[category]}</label>
                                    <textarea id="notes-${category}" rows="3" class="w-full p-2 border rounded bg-gray-50 state-input" placeholder="Add any general observations for this section..."></textarea>
                                </div>
                                <div class="mt-6 pt-4 border-t border-gray-200 flex gap-2 no-print">
                                    <input type="text" id="add-item-input-${category}" class="w-full p-2 border rounded" placeholder="Add a new inspection point...">
                                    <button data-category="${category}" class="add-item-btn bg-indigo-500 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-600">Add</button>
                                </div>
                            </div>`;
                    }
                }
            }

            function updateDashboard() {
                const passCount = inspectionData.filter(item => item.status === 'pass').length;
                const failCount = inspectionData.filter(item => item.status === 'fail').length;
                const naCount = inspectionData.filter(item => item.status === 'na').length;
                const totalApplicable = passCount + failCount;
                const totalCompleted = totalApplicable + naCount;

                const score = totalApplicable > 0 ? ((passCount / totalApplicable) * 100).toFixed(1) : 0;
                
                document.getElementById('summary-text').innerHTML = `
                    <strong class="text-3xl">${score}%</strong><br>
                    <span class="text-green-600">${passCount} Passed</span> | 
                    <span class="text-red-600">${failCount} Failed</span> | 
                    <span class="text-gray-500">${naCount} N/A</span>
                `;
                
                const progressBar = document.getElementById('progress-bar');
                const progressText = document.getElementById('progress-text');
                const progressPercent = inspectionData.length > 0 ? (totalCompleted / inspectionData.length) * 100 : 0;
                progressBar.style.width = `${progressPercent}%`;
                progressText.textContent = `${Math.round(progressPercent)}% Complete (${totalCompleted} of ${inspectionData.length} items)`;


                if (inspectionChart) {
                    inspectionChart.data.datasets[0].data = [passCount, failCount, naCount];
                    inspectionChart.update();
                }
                
                const categoryScores = {};
                Object.keys(sectionTitles).forEach(cat => {
                    const catItems = inspectionData.filter(item => item.category === cat);
                    const catPass = catItems.filter(i => i.status === 'pass').length;
                    const catFail = catItems.filter(i => i.status === 'fail').length;
                    const catTotal = catPass + catFail;
                    categoryScores[cat] = catTotal > 0 ? (catPass / catTotal) * 100 : 0;
                });

                if (categoryScoreChart) {
                    categoryScoreChart.data.labels = Object.keys(categoryScores).map(cat => sectionTitles[cat]);
                    categoryScoreChart.data.datasets[0].data = Object.values(categoryScores);
                    categoryScoreChart.update();
                }
            }

            function createCharts() {
                const inspectionCtx = document.getElementById('inspectionChart').getContext('2d');
                inspectionChart = new Chart(inspectionCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Pass', 'Fail', 'N/A'],
                        datasets: [{ data: [0, 0, 0], backgroundColor: ['#4caf50', '#f44336', '#9e9e9e'], borderColor: '#ffffff', borderWidth: 4 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'bottom', labels: { boxWidth: 15, padding: 20 } } } }
                });

                const categoryScoreCtx = document.getElementById('categoryScoreChart').getContext('2d');
                categoryScoreChart = new Chart(categoryScoreCtx, {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: [{ label: 'Score %', data: [], backgroundColor: ['#6366f1', '#818cf8', '#a5b4fc'] }]
                    },
                    options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, max: 100 } } }
                });
            }

            function updateActionPlan() {
                let failedItems = [...inspectionData.filter(item => item.status === 'fail')];
                const sortValue = document.getElementById('sort-action-plan').value;

                if (sortValue === 'severity') {
                    const severityOrder = { high: 0, medium: 1, low: 2 };
                    failedItems.sort((a, b) => severityOrder[a.severity] - severityOrder[b.severity]);
                }

                const container = document.getElementById('action-plan-content');
                if (failedItems.length > 0) {
                    container.innerHTML = failedItems.map(item => `
                        <div class="p-4 rounded-lg bg-red-50 border border-red-200 action-item">
                            <div class="flex justify-between items-start">
                                <p class="font-semibold text-red-800 flex-1">${item.text}</p>
                                <span class="text-xs font-bold uppercase px-2 py-1 rounded-full ${severityColors[item.severity]}">${item.severity}</span>
                            </div>
                             <p class="text-sm text-red-700 mt-1"><strong>Comment:</strong> ${item.comment || 'No comment provided.'}</p>
                             ${item.photos.length > 0 ? `<div class="mt-2 photo-preview"><p class="text-xs font-semibold text-gray-600 mb-1">PHOTO EVIDENCE</p><div class="flex flex-wrap gap-2">${item.photos.map(p => `<img src="${p}" class="w-24 h-24 object-cover rounded-md border"/>`).join('')}</div></div>` : ''}
                             <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-3 no-print">
                                 <div>
                                     <label for="assignee-${item.id}" class="text-xs font-semibold text-gray-600">ASSIGNED TO</label>
                                     <input type="text" id="assignee-${item.id}" class="w-full p-2 border rounded mt-1 text-sm" placeholder="e.g., John Doe">
                                 </div>
                                 <div>
                                     <label for="deadline-${item.id}" class="text-xs font-semibold text-gray-600">DEADLINE</label>
                                     <input type="date" id="deadline-${item.id}" class="w-full p-2 border rounded mt-1 text-sm">
                                 </div>
                                 <div>
                                     <label for="status-${item.id}" class="text-xs font-semibold text-gray-600">STATUS</label>
                                     <select id="status-${item.id}" class="w-full p-2 border rounded mt-1 text-sm bg-white">
                                        <option value="open">Open</option>
                                        <option value="in_progress">In Progress</option>
                                        <option value="completed">Completed</option>
                                     </select>
                                 </div>
                             </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = `<div class="text-center py-8"><span class="text-3xl">üéâ</span><h3 class="mt-2 text-lg font-medium text-gray-900">All Clear!</h3><p class="mt-1 text-sm text-gray-500">No failed items requiring action. Great job!</p></div>`;
                }
            }
            
            function updatePhotoGallery() {
                const galleryContainer = document.getElementById('photo-gallery-content');
                const itemsWithPhotos = inspectionData.filter(item => item.photos.length > 0);

                if (itemsWithPhotos.length === 0) {
                    galleryContainer.innerHTML = `<p class="text-gray-500">No photos have been uploaded yet.</p>`;
                    return;
                }

                const photosByCategory = itemsWithPhotos.reduce((acc, item) => {
                    if (!acc[item.category]) {
                        acc[item.category] = [];
                    }
                    acc[item.category].push(item);
                    return acc;
                }, {});

                let galleryHtml = '';
                for (const category in photosByCategory) {
                    galleryHtml += `<div class="mb-8"><h3 class="text-xl font-bold border-b pb-2 mb-4">${sectionTitles[category]}</h3>`;
                    photosByCategory[category].forEach(item => {
                        galleryHtml += `<div class="mb-4"><p class="font-semibold text-gray-800">${item.text}</p><p class="text-sm text-gray-600 italic mb-2">${item.comment || ''}</p><div class="flex flex-wrap gap-4">`;
                        item.photos.forEach(photoSrc => {
                            galleryHtml += `<img src="${photoSrc}" class="w-40 h-40 object-cover rounded-lg shadow-md border"/>`;
                        });
                        galleryHtml += `</div></div>`;
                    });
                    galleryHtml += `</div>`;
                }
                galleryContainer.innerHTML = galleryHtml;
            }

            function handleStatusChange(itemId, newStatus) {
                const item = inspectionData.find(i => i.id === itemId);
                if (item) {
                    item.status = newStatus;
                    const itemDiv = document.getElementById(`item-${item.id}`);
                    itemDiv.className = `p-4 rounded-lg shadow-sm item-${newStatus}`;
                    document.querySelectorAll(`#item-${item.id} .pass-fail-btn`).forEach(b => {
                        b.classList.remove('bg-green-500', 'bg-red-500', 'bg-gray-500', 'text-white', 'bg-gray-200', 'text-gray-700');
                        if (b.dataset.status === item.status) {
                            let colorClass = 'bg-gray-200';
                            if (item.status === 'pass') colorClass = 'bg-green-500';
                            if (item.status === 'fail') colorClass = 'bg-red-500';
                            if (item.status === 'na') colorClass = 'bg-gray-500';
                            b.classList.add(colorClass, 'text-white');
                        } else {
                            b.classList.add('bg-gray-200', 'text-gray-700');
                        }
                    });
                    document.getElementById(`details-container-${item.id}`).classList.toggle('hidden', newStatus !== 'fail');
                    updateDashboard();
                    updateActionPlan();
                    saveState();
                }
            }

            function handleCommentChange(itemId, newComment) {
                 const item = inspectionData.find(i => i.id === itemId);
                 if(item) {
                     item.comment = newComment;
                     updateActionPlan();
                     const printCommentDiv = document.querySelector(`#item-${itemId} .print\\:block`);
                     if (printCommentDiv) {
                        printCommentDiv.innerHTML = newComment ? `<p class="text-sm text-gray-700 mt-1"><strong>Comment:</strong> ${newComment}</p>` : '';
                     }
                     saveState();
                 }
            }
            
            function handlePhotoChange(itemId, files) {
                const item = inspectionData.find(i => i.id === itemId);
                if (item && files.length > 0) {
                    const previewContainer = document.querySelector(`#details-container-${itemId} .photo-preview`);
                    for(const file of files) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            item.photos.push(e.target.result);
                            const img = document.createElement('img');
                            img.src = e.target.result;
                            img.className = "w-24 h-24 object-cover rounded-md shadow-sm";
                            previewContainer.appendChild(img);
                            updateActionPlan();
                            updatePhotoGallery();
                            saveState();
                        };
                        reader.readAsDataURL(file);
                    }
                }
            }

            function handleAddItem(category) {
                const input = document.getElementById(`add-item-input-${category}`);
                const text = input.value.trim();
                if (text) {
                    const newItem = {
                        id: nextItemId++,
                        category: category,
                        text: text,
                        status: 'pending',
                        comment: '',
                        photos: [],
                        severity: 'low'
                    };
                    inspectionData.push(newItem);
                    document.getElementById(`checklist-container-${category}`).insertAdjacentHTML('beforeend', buildChecklistItem(newItem));
                    input.value = '';
                    updateDashboard();
                    saveState();
                }
            }

            function handleSeverityChange(itemId, newSeverity) {
                const item = inspectionData.find(i => i.id === itemId);
                if(item) {
                    item.severity = newSeverity;
                    updateActionPlan();
                    saveState();
                }
            }

            function saveState() {
                const appState = {
                    inspectionId: inspectionId,
                    inspectionData: inspectionData,
                    nextItemId: nextItemId,
                    formValues: {}
                };
                document.querySelectorAll('.state-input').forEach(input => {
                    appState.formValues[input.id] = input.value;
                });
                localStorage.setItem('inspectionAppState', JSON.stringify(appState));
                
                const saveIndicator = document.getElementById('save-indicator');
                saveIndicator.classList.remove('opacity-0');
                setTimeout(() => {
                    saveIndicator.classList.add('opacity-0');
                }, 1500);
            }

            function loadState() {
                const savedState = localStorage.getItem('inspectionAppState');
                if (savedState) {
                    const appState = JSON.parse(savedState);
                    inspectionId = appState.inspectionId;
                    inspectionData = appState.inspectionData;
                    nextItemId = appState.nextItemId || (inspectionData.length > 0 ? Math.max(...inspectionData.map(i => i.id)) + 1 : 1);
                    Object.keys(appState.formValues).forEach(id => {
                        const input = document.getElementById(id);
                        if (input) input.value = appState.formValues[id];
                    });
                } else {
                    const date = new Date();
                    const dateString = `${date.getFullYear()}${(date.getMonth() + 1).toString().padStart(2, '0')}${date.getDate().toString().padStart(2, '0')}`;
                    inspectionId = `INSP-${dateString}-${Math.random().toString(36).substr(2, 5).toUpperCase()}`;
                    inspectionData = JSON.parse(JSON.stringify(initialState));
                    nextItemId = inspectionData.length + 1;
                    document.getElementById('inspectionDate').value = date.toISOString().slice(0, 10);
                }
                renderAll();
            }
            
            function renderAll() {
                renderChecklists();
                updateDashboard();
                updateActionPlan();
                updatePhotoGallery();
            }

            function exportToCSV() {
                let csvContent = "data:text/csv;charset=utf-8,";
                const headers = ["ID", "Category", "Checklist Item", "Status", "Severity", "Comment", "Photo Count"];
                csvContent += headers.join(",") + "\r\n";

                inspectionData.forEach(item => {
                    const row = [
                        item.id,
                        sectionTitles[item.category],
                        `"${item.text.replace(/"/g, '""')}"`,
                        item.status,
                        item.status === 'fail' ? item.severity : 'N/A',
                        `"${item.comment.replace(/"/g, '""')}"`,
                        item.photos.length
                    ];
                    csvContent += row.join(",") + "\r\n";
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `inspection_report_${inspectionId}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            document.body.addEventListener('click', function(e) {
                const passFailBtn = e.target.closest('.pass-fail-btn');
                if (passFailBtn) {
                    handleStatusChange(parseInt(passFailBtn.dataset.id), passFailBtn.dataset.status);
                }
                const addBtn = e.target.closest('.add-item-btn');
                if (addBtn) {
                    handleAddItem(addBtn.dataset.category);
                }
            });

            document.body.addEventListener('input', function(e) {
                if (e.target.matches('.comment-input')) {
                     handleCommentChange(parseInt(e.target.dataset.id), e.target.value);
                }
                if (e.target.matches('.state-input')) {
                    saveState();
                }
            });
            
            document.body.addEventListener('change', function(e) {
                if (e.target.matches('.photo-input')) {
                    handlePhotoChange(parseInt(e.target.dataset.id), e.target.files);
                }
                if (e.target.matches('.severity-select')) {
                    handleSeverityChange(parseInt(e.target.dataset.id), e.target.value);
                }
                if (e.target.id === 'sort-action-plan') {
                    updateActionPlan();
                }
            });

            navLinks.forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();
                    navLinks.forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                    const targetId = this.getAttribute('href').substring(1);
                    contentSections.forEach(section => {
                        section.classList.toggle('active', section.id === targetId);
                    });
                });
            });

            document.getElementById('print-btn').addEventListener('click', () => {
                const storeName = document.getElementById('storeName').value || 'N/A';
                const location = document.getElementById('location').value || 'N/A';
                const inspector = document.getElementById('inspector').value || 'N/A';
                let date = document.getElementById('inspectionDate').value;
                const overallComments = document.getElementById('overall-comments').value;

                if (date) {
                    const dateObj = new Date(date);
                    const userTimezoneOffset = dateObj.getTimezoneOffset() * 60000;
                    date = new Date(dateObj.getTime() + userTimezoneOffset).toLocaleDateString();
                } else {
                    date = 'N/A';
                }

                document.getElementById('print-inspection-id').textContent = `ID: ${inspectionId}`;
                document.getElementById('print-store-name').textContent = `Store: ${storeName}`;
                document.getElementById('print-location').textContent = `Location: ${location}`;
                document.getElementById('print-date').textContent = `Date: ${date}`;
                document.getElementById('print-inspector').textContent = `Inspected By: ${inspector}`;
                
                const commentsContainer = document.getElementById('print-summary-comments');
                if (overallComments) {
                    commentsContainer.innerHTML = `<div class="mb-8"><h2 class="text-xl font-bold mb-2">Overall Comments</h2><p class="text-gray-700 whitespace-pre-wrap">${overallComments}</p></div>`;
                } else {
                    commentsContainer.innerHTML = '';
                }
                
                const notesContainer = document.getElementById('print-general-notes');
                let notesHtml = '';
                Object.keys(sectionTitles).forEach(cat => {
                    const note = document.getElementById(`notes-${cat}`).value;
                    if (note) {
                        notesHtml += `<div class="mb-4"><h3 class="font-bold">${sectionTitles[cat]} Notes</h3><p class="text-gray-700 whitespace-pre-wrap">${note}</p></div>`;
                    }
                });
                if (notesHtml) {
                    notesContainer.innerHTML = `<div class="mb-8"><h2 class="text-xl font-bold mb-2">General Section Notes</h2>${notesHtml}</div>`;
                } else {
                    notesContainer.innerHTML = '';
                }

                window.print();
            });

            document.getElementById('export-csv-btn').addEventListener('click', exportToCSV);
            
            const resetModal = document.getElementById('reset-modal');
            document.getElementById('reset-btn').addEventListener('click', () => {
                resetModal.classList.remove('hidden');
            });
            document.getElementById('cancel-reset').addEventListener('click', () => {
                resetModal.classList.add('hidden');
            });
            document.getElementById('confirm-reset').addEventListener('click', () => {
                localStorage.removeItem('inspectionAppState');
                document.querySelectorAll('.state-input').forEach(input => input.value = '');
                loadState();
                resetModal.classList.add('hidden');
            });

            // Initial setup
            createCharts();
            loadState();
        });
    </script>

</body>
</html>